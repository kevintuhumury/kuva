/*!
 * Justified Gallery - v3.0.1
 * http://miromannino.com/projects/justified-gallery/
 * Copyright (c) 2014 Miro Mannino
 * Licensed under the MIT license.
 */
!function(a){a.fn.justifiedGallery=function(b){function c(a,b,c){var d;return d=a>b?a:b,100>=d?c.settings.sizeRangeSuffixes.lt100:240>=d?c.settings.sizeRangeSuffixes.lt240:320>=d?c.settings.sizeRangeSuffixes.lt320:500>=d?c.settings.sizeRangeSuffixes.lt500:640>=d?c.settings.sizeRangeSuffixes.lt640:c.settings.sizeRangeSuffixes.lt1024}function d(b){a(b.currentTarget).find(".caption").stop().fadeTo(500,.7)}function e(b){a(b.currentTarget).find(".caption").stop().fadeTo(500,0)}function f(b,f,g,h,i,j,k){var l=b.find("img");l.css("margin-left",-h/2),l.css("margin-top",-i/2),b.width(h),b.height(j),b.css("top",g),b.css("left",f);var m=l.attr("src"),n=m.replace(k.settings.extension,"").replace(k.usedSizeRangeRegExp,"")+c(h,i,k)+m.match(k.settings.extension)[0];l.one("error",function(){l.attr("src",l.data("jg.originalSrc"))}),b.stop().fadeTo(300,1,function(){m!==n&&l.attr("src",n)});var o=b.data("jg.captionMouseEvents");if(k.settings.captions===!0){var p=b.find(".caption");if(0===p.length){var q=l.attr("alt");"undefined"==typeof q&&(q=b.attr("title")),"undefined"!=typeof q&&(p=a('<div class="caption">'+q+"</div>"),b.append(p))}0!==p.length&&"undefined"==typeof o&&(o={mouseenter:d,mouseleave:e},b.on("mouseenter",o.mouseenter),b.on("mouseleave",o.mouseleave),b.data("jg.captionMouseEvents",o))}else"undefined"!=typeof o&&(b.off("mouseenter",o.mouseenter),b.off("mouseleave",o.mouseleave),b.removeData("jg.captionMouseEvents"))}function g(a,b){var c,d,e,f,g,h,i=!0,j=0,k=a.galleryWidth,l=k-a.buildingRow.width-(a.buildingRow.entriesBuff.length-1)*a.settings.margins;if(b&&"hide"===a.settings.lastRow&&l/k>.35){for(c=0;c<a.buildingRow.entriesBuff.length;c++)d=a.buildingRow.entriesBuff[c],d.stop().fadeTo(0);return-1}for(b&&"nojustify"===a.settings.lastRow&&l/k>.35&&(i=!1),c=0;c<a.buildingRow.entriesBuff.length;c++)e=a.buildingRow.entriesBuff[c].find("img"),f=Math.ceil(e.data("jg.imgw")/(e.data("jg.imgh")/a.settings.rowHeight)),i?(g=c<a.buildingRow.entriesBuff.length-1?f+Math.ceil(f/a.buildingRow.width*l):k,h=Math.ceil(a.settings.rowHeight*(g/f)),a.settings.fixedHeight&&h<a.settings.rowHeight&&(g=f,h=a.settings.rowHeight)):(g=f,h=a.settings.rowHeight),e.width(g),e.height(h),k-=g+(c<a.buildingRow.entriesBuff.length-1?a.settings.margins:0),(0===c||j>h)&&(j=h);return a.settings.fixedHeight&&(j=a.settings.rowHeight),j}function h(a){a.lastAnalyzedIndex=-1,a.buildingRow.entriesBuff=[],a.buildingRow.width=0,a.offY=0,a.firstRowFlushed=!1}function i(a,b){var c,d,e,h=0;if(e=g(a,b),b&&"hide"===a.settings.lastRow&&-1===e)return a.buildingRow.entriesBuff=[],void(a.buildingRow.width=0);a.settings.maxRowHeight>0&&a.settings.maxRowHeight<e?e=a.settings.maxRowHeight:0===a.settings.maxRowHeight&&1.5*a.settings.rowHeight<e&&(e=1.5*a.settings.rowHeight);for(var i=0;i<a.buildingRow.entriesBuff.length;i++)c=a.buildingRow.entriesBuff[i],d=c.find("img"),f(c,h,a.offY,d.width(),d.height(),e,a),h+=d.width()+a.settings.margins;a.$gallery.height(a.offY+e+(a.spinner.active?a.spinner.$el.innerHeight():0)),b||(a.offY+=e+a.settings.margins,a.buildingRow.entriesBuff=[],a.buildingRow.width=0,a.firstRowFlushed=!0)}function j(a){a.checkWidthIntervalId=setInterval(function(){var b=parseInt(a.$gallery.width(),10);a.galleryWidth!==b&&(a.galleryWidth=b,h(a),m(a,!0))},a.settings.refreshTime)}function k(a){clearInterval(a.intervalId),a.intervalId=setInterval(function(){a.phase<a.$points.length?a.$points.eq(a.phase).fadeTo(a.timeslot,1):a.$points.eq(a.phase-a.$points.length).fadeTo(a.timeslot,0),a.phase=(a.phase+1)%(2*a.$points.length)},a.timeslot)}function l(a){clearInterval(a.intervalId),a.intervalId=null}function m(a,b){a.yield.flushed=0,null!==a.imgAnalyzerTimeout&&clearTimeout(a.imgAnalyzerTimeout),a.imgAnalyzerTimeout=setTimeout(function(){n(a,b)},.001)}function n(b,c){for(var d=b.lastAnalyzedIndex+1;d<b.entries.length;d++){var e=a(b.entries[d]),f=e.find("img");if(f.data("jg.loaded")===!0){var g=Math.ceil(f.data("jg.imgw")/(f.data("jg.imgh")/b.settings.rowHeight));if(b.buildingRow.entriesBuff.push(e),b.buildingRow.width+=g,b.lastAnalyzedIndex=d,b.buildingRow.width+g+(b.buildingRow.entriesBuff.length-1)*b.settings.margins>b.galleryWidth&&(i(b,b.firstRowFlushed&&d>=b.entries.length-1),++b.yield.flushed>=b.yield.every))return void m(b,c)}else if("error"!==f.data("jg.loaded"))return}b.buildingRow.entriesBuff.length>0&&i(b,b.firstRowFlushed),b.spinner.active&&(b.spinner.active=!1,b.$gallery.height(b.$gallery.height()-b.spinner.$el.innerHeight()),b.spinner.$el.detach(),l(b.spinner)),b.$gallery.trigger(c?"jg.resize":"jg.complete")}var o={sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,maxRowHeight:0,margins:1,lastRow:"nojustify",fixedHeight:!1,captions:!0,rel:null,target:null,extension:/\.[^.]+$/,refreshTime:250,randomize:!1};return this.each(function(c,d){var e=a(d);e.addClass("justified-gallery");var f=e.data("jg.context");if("undefined"==typeof f){if("undefined"!=typeof b&&null!==b&&"object"!=typeof b)throw"The argument must be an object";var g=a('<div class="spinner"><span></span><span></span><span></span></div>');f={settings:a.extend({},o,b),imgAnalyzerTimeout:null,entries:null,buildingRow:{entriesBuff:[],width:0},lastAnalyzedIndex:-1,firstRowFlushed:!1,"yield":{every:2,flushed:0},offY:0,spinner:{active:!1,phase:0,timeslot:150,$el:g,$points:g.find("span"),intervalId:null},checkWidthIntervalId:null,galleryWidth:e.width(),$gallery:e},e.data("jg.context",f)}else"norewind"===b||(f.settings=a.extend({},f.settings,b),h(f));if(f.entries=e.find("a").toArray(),0!==f.entries.length){f.settings.randomize&&(f.entries.sort(function(){return 2*Math.random()-1}),a.each(f.entries,function(){a(this).appendTo(e)})),f.usedSizeRangeRegExp=new RegExp("("+f.settings.sizeRangeSuffixes.lt100+"|"+f.settings.sizeRangeSuffixes.lt240+"|"+f.settings.sizeRangeSuffixes.lt320+"|"+f.settings.sizeRangeSuffixes.lt500+"|"+f.settings.sizeRangeSuffixes.lt640+"|"+f.settings.sizeRangeSuffixes.lt1024+")$"),f.settings.maxRowHeight>0&&f.settings.maxRowHeight<f.settings.rowHeight&&(f.settings.maxRowHeight=f.settings.rowHeight);var i=!1;a.each(f.entries,function(b,c){var d=a(c),g=d.find("img");if(g.data("jg.loaded")!==!0){g.data("jg.loaded",!1),i=!0,f.spinner.active===!1&&(f.spinner.active=!0,e.append(f.spinner.$el),e.height(f.offY+f.spinner.$el.innerHeight()),k(f.spinner)),null!==f.settings.rel&&d.attr("rel",f.settings.rel),null!==f.settings.target&&d.attr("target",f.settings.target);var h="undefined"!=typeof g.data("safe-src")?g.data("safe-src"):g.attr("src");g.data("jg.originalSrc",h),g.attr("src",h);var j=new Image,l=a(j);l.one("load",function(){g.off("load error"),g.data("jg.imgw",j.width),g.data("jg.imgh",j.height),g.data("jg.loaded",!0),m(f,!1)}),l.one("error",function(){g.off("load error"),g.data("jg.loaded","error"),m(f,!1)}),j.src=h}}),i||m(f,!1),j(f)}})}}(jQuery);
